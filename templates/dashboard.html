{% extends "base.html" %}

{% block title %}Dashboard - Budget Tracker{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-primary mb-2 dark:text-dark-primary">Home</h1>
        <p class="text-gray-600 dark:text-a0aec0">Welcome back, {{ session.username }}!</p>
    </div>

    {# New structure for financial summary boxes #}
    <div class="mb-8">
        {# Net Balance (All Time) - now spans the full width of the section #}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow-lg p-6 md:col-span-2 dark:bg-dark-bg-2 dark:shadow-xl">
                <h3 class="text-lg font-semibold text-gray-700 mb-2 dark:text-dark-text">Net Balance (All Time)</h3>
                <p class="text-3xl font-bold {% if total_income - total_expense >= 0 %}text-green-600{% else %}text-red-600{% endif %} dark:text-dark-text">
                    ₱{{ "%.2f"|format(total_income - total_expense) }}
                </p>
            </div>
        </div>
        {# Total Income and Total Expenses - side-by-side below Net Balance #}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-lg p-6 dark:bg-dark-bg-2 dark:shadow-xl">
                <h3 class="text-lg font-semibold text-gray-700 mb-2 dark:text-dark-text">Total Income (All Time)</h3>
                <p class="text-3xl font-bold text-green-600 dark:text-green-400">
                    ₱{{ "%.2f"|format(total_income) }}
                </p>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6 dark:bg-dark-bg-2 dark:shadow-xl">
                <h3 class="text-lg font-semibold text-gray-700 mb-2 dark:text-dark-text">Total Expenses (All Time)</h3>
                <p class="text-3xl font-bold text-red-600 dark:text-red-400">
                    ₱{{ "%.2f"|format(total_expense) }}
                </p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        {# Pie Chart Section #}
        <div class="bg-white rounded-lg shadow-lg p-6 dark:bg-dark-bg-2 dark:shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 dark:text-dark-text">Overall Financial Overview (By Category)</h2>
            <div class="flex items-center mb-4">
                <label for="pieChartType" class="mr-2 text-gray-700 dark:text-cbd5e0">Type:</label>
                <select id="pieChartType" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                    <option value="expense" selected>Expenses</option>
                    <option value="income">Income</option>
                    <option value="both">All (Income & Expense)</option>
                </select>
                <label for="pieChartPeriod" class="ml-4 mr-2 text-gray-700 dark:text-cbd5e0">Period:</label>
                <select id="pieChartPeriod" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                    <option value="month" selected>This Month</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="year">This Year</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            <div class="chart-container relative" style="height:300px; width:100%;">
                <canvas id="pieChart"></canvas>
                <div class="absolute inset-0 flex items-center justify-center hidden" id="pieNoDataMessage">
                    <p class="text-gray-500 text-center text-lg dark:text-gray-400">No transactions for this period.</p>
                </div>
            </div>
            <div id="pieChartLegend" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm max-h-48 overflow-y-auto">
            </div>
        </div>

        {# Bar Chart Section #}
        <div class="bg-white rounded-lg shadow-lg p-6 dark:bg-dark-bg-2 dark:shadow-xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 dark:text-dark-text">Monthly/Daily/Yearly Trend</h2>
            <div class="flex items-center mb-4">
                <label for="barChartType" class="mr-2 text-gray-700 dark:text-cbd5e0">Type:</label>
                <select id="barChartType" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                    <option value="expense" selected>Expenses</option>
                    <option value="income">Income</option>
                    <option value="both">All (Income & Expense)</option>
                </select>
                <label for="barChartPeriod" class="ml-4 mr-2 text-gray-700 dark:text-cbd5e0">Period:</label>
                <select id="barChartPeriod" class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:border-gray-600 dark:text-dark-text">
                    <option value="month" selected>This Month</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="year">This Year</option>
                    <option value="all">All Time</option>
                </select>
            </div>
            <div class="chart-container relative overflow-x-auto" style="height:300px; width:100%;">
                <canvas id="barChart"></canvas>
                <div class="absolute inset-0 flex items-center justify-center hidden" id="barNoDataMessage">
                    <p class="text-gray-500 text-center text-lg dark:text-gray-400">No transactions for this period.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let pieChartInstance = null;
    let barChartInstance = null;

    const pieChartType = document.getElementById('pieChartType');
    const pieChartPeriod = document.getElementById('pieChartPeriod');
    const barChartType = document.getElementById('barChartType');
    const barChartPeriod = document.getElementById('barChartPeriod');

    const getChartDefaults = (isDarkMode) => {
        const textColor = isDarkMode ? '#e2e8f0' : '#4a5568';
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        return {
            fontColor: textColor,
            gridColor: gridColor
        };
    };

    function loadPieChartData(type, period) {
        const chartDefaults = getChartDefaults(document.documentElement.classList.contains('dark'));
        const canvas = document.getElementById('pieChart');
        const noDataMessageDiv = document.getElementById('pieNoDataMessage');

        fetch(`/get_transactions_data?period=${period}&dataType=${type}&mode=category`)
            .then(response => response.json())
            .then(data => {
                if (pieChartInstance) {
                    pieChartInstance.destroy();
                }

                if (data.chartData.labels.length > 0) {
                    canvas.style.display = 'block'; // Show canvas
                    noDataMessageDiv.classList.add('hidden'); // Hide no data message

                    pieChartInstance = new Chart(canvas, {
                        type: 'pie',
                        data: data.chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false // We will create a custom legend
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                label += '₱' + context.parsed.toFixed(2);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    updatePieChartLegend(data.legendData);
                } else {
                    canvas.style.display = 'none'; // Hide canvas if no data
                    noDataMessageDiv.classList.remove('hidden'); // Show no data message
                    document.getElementById('pieChartLegend').innerHTML = ''; // Clear legend
                }
            })
            .catch(error => {
                console.error('Error loading pie chart data:', error);
                canvas.style.display = 'none';
                noDataMessageDiv.classList.remove('hidden');
                noDataMessageDiv.textContent = 'Error loading chart data.';
                document.getElementById('pieChartLegend').innerHTML = '';
            });
    }

    function updatePieChartLegend(legendData) {
        const legendDiv = document.getElementById('pieChartLegend');
        legendDiv.innerHTML = ''; // Clear previous legend items

        legendData.forEach(item => {
            const legendItem = document.createElement('div');
            legendItem.className = 'flex justify-between items-center py-1 px-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors';
            const colorClass = item.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

            legendItem.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-4 h-4 rounded" style="background-color: ${item.color}"></div>
                    <span class="text-gray-700 dark:text-dark-text">${item.name}</span>
                </div>
                <span class="font-semibold ${colorClass}">₱${item.value.toFixed(2)}</span>
            `;
            legendDiv.appendChild(legendItem);
        });
    }

    function loadBarChartData(type, period) {
        const chartDefaults = getChartDefaults(document.documentElement.classList.contains('dark'));
        const canvas = document.getElementById('barChart');
        const noDataMessageDiv = document.getElementById('barNoDataMessage');

        fetch(`/get_transactions_bar_data?period=${period}&dataType=${type}`)
            .then(response => response.json())
            .then(data => {
                if (barChartInstance) {
                    barChartInstance.destroy();
                }

                if (data.chartData.labels.length > 0 && data.chartData.datasets[0].data.some(amount => amount > 0)) {
                    canvas.style.display = 'block';
                    noDataMessageDiv.classList.add('hidden');

                    barChartInstance = new Chart(canvas, {
                        type: 'bar',
                        data: data.chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += '₱' + context.parsed.y.toFixed(2);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        color: chartDefaults.fontColor // X-axis label color
                                    },
                                    grid: {
                                        color: chartDefaults.gridColor // X-axis grid line color
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: chartDefaults.fontColor, // Y-axis label color
                                        callback: function(value) {
                                            return '₱' + value.toFixed(2);
                                        }
                                    },
                                    grid: {
                                        color: chartDefaults.gridColor // Y-axis grid line color
                                    }
                                }
                            }
                        }
                    });
                } else {
                    canvas.style.display = 'none';
                    noDataMessageDiv.classList.remove('hidden');
                }
            })
            .catch(error => {
                console.error('Error loading bar chart data:', error);
                canvas.style.display = 'none';
                noDataMessageDiv.classList.remove('hidden');
                noDataMessageDiv.textContent = 'Error loading chart data.';
            });
    }

    // Initial load
    loadPieChartData(pieChartType.value, pieChartPeriod.value);
    loadBarChartData(barChartType.value, barChartPeriod.value);

    // Event listeners for filters
    pieChartType.addEventListener('change', function() {
        loadPieChartData(this.value, pieChartPeriod.value);
    });

    pieChartPeriod.addEventListener('change', function() {
        loadPieChartData(pieChartType.value, this.value);
    });

    barChartType.addEventListener('change', function() {
        loadBarChartData(this.value, barChartPeriod.value);
    });

    barChartPeriod.addEventListener('change', function() {
        loadBarChartData(barChartType.value, this.value);
    });

    // Handle dark mode for chart axis/grid lines
    const htmlElement = document.documentElement; // Get the root HTML element
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'class') {
                // Re-render charts when theme changes
                if (pieChartInstance) pieChartInstance.destroy(); pieChartInstance = null; // Destroy to force recreation with new colors
                if (barChartInstance) barChartInstance.destroy(); barChartInstance = null;
                loadPieChartData(pieChartType.value, pieChartPeriod.value);
                loadBarChartData(barChartType.value, barChartPeriod.value);
            }
        });
    });
    observer.observe(htmlElement, { attributes: true });

});
</script>
{% endblock %}
